@model List<FplMatchesModel.Event>

<section class="fpl-section py-5 fade-in">
    <div class="container">
        <h2 class="text-center mb-4">Upcoming FPL Events</h2>
        <div class="row g-4">
            @foreach (var eventItem in Model)
            {
                var localDeadlineTime = TimeZoneInfo.ConvertTimeFromUtc(eventItem.DeadlineTime, TimeZoneInfo.FindSystemTimeZoneById("Romance Standard Time"));
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">@eventItem.Name</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="mb-3">
                                <small class="text-muted">Next deadline:</small>
                                <p class="mb-1">
                                    <strong>@localDeadlineTime.ToString("dd/MM/yyyy HH:mm")</strong>
                                </p>
                            </div>

                            <div class="mt-auto">
                                <div class="countdown-container">
                                    <small class="text-muted d-block">Time remaining:</small>
                                    <strong id="countdown-@eventItem.Id" class="countdown-timer" aria-live="polite" aria-label="Countdown to deadline for @eventItem.Name"></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script>
                    document.addEventListener('DOMContentLoaded', (event) => {
                        function updateCountdown(deadline, elementId) {
                            const countdownElement = document.getElementById(elementId);
                            const deadlineDate = new Date(deadline);

                            function calculateTimeLeft() {
                                const now = new Date();
                                const timeLeft = deadlineDate - now;

                                if (timeLeft < 0) {
                                    countdownElement.innerHTML = "Event has started";
                                    countdownElement.classList.add('text-muted');
                                    return;
                                }

                                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                                countdownElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;

                                // Calculate color based on time left relative to 7 days
                                const totalHours = (deadlineDate - now) / (1000 * 60 * 60);
                                const maxHours = 7 * 24; // 7 days
                                const green = Math.min(255, Math.max(0, (totalHours / maxHours) * 150));
                                const red = 255 - green;
                                countdownElement.style.color = `rgb(${red}, ${green}, 0)`;
                            }

                            calculateTimeLeft();
                            const interval = setInterval(calculateTimeLeft, 1000);
                        }

                        updateCountdown('@localDeadlineTime.ToString("yyyy-MM-ddTHH:mm:ssZ")', 'countdown-@eventItem.Id');
                    });
                </script>
            }
        </div>
    </div>
</section>